C51 COMPILER V7.06   TEST                                                                  11/30/2018 13:41:24 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE TEST
OBJECT MODULE PLACED IN test.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE test.c OPTIMIZE(9,SPEED) BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          /*
   2          G162 驱动无背光的HT1621 3+5断码屏
   3          
   4          STC12C5A40S2 3.57MHz
   5          
   6          倒时器，内置温度计
   7          
   8          
   9          2018-7-31
  10          */
  11          
  12          sfr P4          =   0xc0;
  13          sfr P4SW = 0xBB;
  14          
  15          
  16          #include<reg52.h> //包含头文件，一般情况不需要改动，头文件包含特殊功能寄存器的定义
  17          #include<intrins.h>
  18          
  19          //D1201控制位（液晶模块接口定义，根据自已的需要更改）
  20          sbit D1201_DAT=P0^3;
  21          sbit D1201_CS=P0^0;     //lower enable
  22          sbit D1201_WR=P0^2;     //rising edge
  23          sbit D1201_RD=P0^1;
  24          
  25          #include "LCD-1621.c"     //3+5位段式液晶无背光 0.5元 LCD-V5.3 5v供电效果最好
  26          //#include "DelayMs_15F104E6.h"    //15F104 6M延时
  27          
  28          sfr P3M0        =   0xB2;   //0000,0000 端口3模式寄存器0
  29          
  30          #include "ad.h"
  31          
  32          sbit spk=P3^4;
  33          sbit led=P4^0;
  34          
  35          unsigned int cc;  //200ns 变量
  36          unsigned int st;  //计秒变量
  37          bit run;          //是否倒时
  38          
  39          sbit key1=P1^0;    //按钮1
  40          sbit key2=P1^1;    //按钮2
  41          sbit key3=P1^2;
  42          
  43          
  44          
  45          
  46          
  47          /*------------------------------------------------
  48           uS延时函数，含有输入参数 unsigned char t，无返回值
  49           unsigned char 是定义无符号字符变量，其值的范围是
  50           0~255 这里使用晶振12M，精确延时请使用汇编,大致延时
  51           长度如下 T=tx2+5 uS 
  52          ------------------------------------------------*/
  53          void DelayUs2x(unsigned char t)
  54          {   
  55   1       while(--t);
C51 COMPILER V7.06   TEST                                                                  11/30/2018 13:41:24 PAGE 2   

  56   1      }
  57          
  58          void DelayMs(unsigned int t)
  59          {
  60   1      while(--t)
  61   1      {
  62   2      DelayUs2x(235);
  63   2      DelayUs2x(235);
  64   2      }
  65   1      }
  66          
  67          
  68          
  69          /*------------------------------------------------
  70                             蜂呜器子程序
  71          ------------------------------------------------*/
  72          void beep()
  73          {
  74   1      unsigned char y;
  75   1      
  76   1      for(y=0;y<100;y++)
  77   1       {
  78   2        spk=0;
  79   2        DelayUs2x(250);  DelayUs2x(50);
  80   2        spk=1;
  81   2        DelayUs2x(250);  DelayUs2x(50);
  82   2       }
  83   1      
  84   1      }
  85          
  86          
  87          
  88          
  89          
  90          
  91          
  92          /*------------------------------------------------
  93                             蜂呜器子程序
  94          ------------------------------------------------*/
  95          void beep1()
  96          {
  97   1      unsigned char y;
  98   1      
  99   1      for(y=0;y<100;y++)
 100   1       {
 101   2        spk=0;
 102   2        DelayUs2x(250); 
 103   2        spk=1;
 104   2        DelayUs2x(250); 
 105   2       }
 106   1      
 107   1      }
 108          
 109          
 110          /*---------------------------------
 111               AD 转成温度，返回温度的10倍
 112          ----------------------------------*/
 113          unsigned int getwd(unsigned int wd)
 114          {
 115   1      unsigned int x1,x2; //AD计算中间量
 116   1      unsigned char x3,x4; //AD计算中间量
 117   1                 {x1=150; x2=602; x3=63; x4=65; } //8.3-15度
C51 COMPILER V7.06   TEST                                                                  11/30/2018 13:41:24 PAGE 3   

 118   1      if(wd<602) {x1=198; x2=542; x3=48; x4=60; } //15-19.8度
 119   1      if(wd<542) {x1=225; x2=515; x3=1; x4=1; } //19.8-22.5度
 120   1      if(wd<515) {x1=250; x2=484; x3=25; x4=31; } //22.5-25度
 121   1      if(wd<484) {x1=275; x2=459; x3=1; x4=1; } //25-27.5度
 122   1      if(wd<459) {x1=300; x2=439; x3=25; x4=20; } //27.5-30度
 123   1      if(wd<439) {x1=350; x2=396; x3=50; x4=43; } //30-35度
 124   1      if(wd<396) {x1=502; x2=291; x3=52; x4=36; } //50-35度
 125   1      
 126   1      return ( x1 - ( wd - x2) * x3 / x4 );
 127   1      }
 128          
 129          
 130          
 131          
 132          
 133          
 134          
 135          
 136          
 137          /*------------------------------------------------
 138                              定时器初始化子程序 定时器0
 139          ------------------------------------------------*/
 140          void Init_Timer0(void)
 141          {
 142   1       TMOD |= 0x02;    //使用模式2，八位自动重装定时器                    
 143   1       TH0=0x05;            //给定初值，250ns一个中断
 144   1       TL0=0x05;
 145   1       EA=1;            //总中断打开
 146   1       ET0=1;           //定时器中断打开
 147   1       TR0=1;           //定时器开关打开
 148   1      }
 149          
 150          
 151          
 152          /*------------------------------------------------
 153                           定时器中断子程序 0
 154          ------------------------------------------------*/
 155          void Timer0_isr(void) interrupt 1 using 1
 156          {
 157   1       cc++;
 158   1       if(cc==1223)  // 使用4M晶振，1333，使用12M晶振时4000
 159   1        {
 160   2          cc=0;
 161   2          if(run)  //正在倒计时
 162   2          if(st)  st--;
 163   2        }
 164   1      }
 165          
 166          
 167          
 168          
 169          
 170          
 171          
 172          
 173          
 174          
 175          
 176          
 177          /*------------------------------------------------
 178                                 显示
 179          ------------------------------------------------*/
C51 COMPILER V7.06   TEST                                                                  11/30/2018 13:41:24 PAGE 4   

 180          void disp4led()
 181          {
 182   1      print(1,st/3600/10,0);
 183   1      print(2,(st/3600)%10,0);
 184   1      print(3,22,0);
 185   1      print(4,(st%3600)/60/10,0);
 186   1      print(5,(st%3600)/60%10,0);
 187   1      print(6,22,0);
 188   1      print(7,st%60/10,0);
 189   1      print(8,st%60%10,0);
 190   1      
 191   1      }
 192          
 193          
 194          
 195          
 196          
 197          
 198          
 199          /*------------------------------------------------
 200                               main
 201          ------------------------------------------------*/
 202          void main()
 203          {
 204   1      unsigned int wd; //温度
 205   1      unsigned int s2; //上一秒
 206   1      unsigned char i; //for的变量
 207   1      unsigned char ca2; //长按用变量
 208   1      unsigned int ca3; //待机状态计时 ,用于显示温度
 209   1      
 210   1      P4SW=0x70;    //将P4.4 P4.5 P4.6设为IO口
 211   1      
 212   1      run=0;  //不倒时
 213   1      
 214   1      InitADC();
 215   1      Init_Timer0();
 216   1      D1621_Init();
 217   1      cls();
 218   1      
 219   1      beep();
 220   1      
 221   1      
 222   1      
 223   1      
 224   1      
 225   1      
 226   1      
 227   1      st=0;
 228   1      s2=1;
 229   1      while(1)
 230   1      {
 231   2       if(run==0) //如果是待机状态，一会儿就进入温度计界面
 232   2       {
 233   3        DelayMs(30);
 234   3        ca3++;
 235   3        if(ca3==2500)
 236   3         {
 237   4           ca3=0;
 238   4           wd=getwd(1023-ad(6));  //由于电路上 RT 和分压电阻的位置交换，所以程序里要倒一下，算法才对
 239   4           print(1,21,0);
 240   4           print(2,21,0);
 241   4           print(3,21,0);
C51 COMPILER V7.06   TEST                                                                  11/30/2018 13:41:24 PAGE 5   

 242   4           print(4,21,0);
 243   4           if(wd>99) print(4,wd/100,0);
 244   4           print(5,wd%100/10,0);
 245   4           print(6,21,0);
 246   4           print(7,21,0);
 247   4           print(8,21,0);
 248   4         }
 249   3       }
 250   2      
 251   2       if(s2!=st)
 252   2       {
 253   3        disp4led();    //写入显示缓冲区
 254   3        s2=st;
 255   3        led=~run;
 256   3       }
 257   2      
 258   2       if(!key1)   //加1分
 259   2        {
 260   3         DelayMs(30);
 261   3         if(!key1)
 262   3          {
 263   4           run=0;
 264   4           st+=60;
 265   4           disp4led();     
 266   4           beep();
 267   4           ca2=0; //长按计时清零
 268   4           while(!key1) 
 269   4            {
 270   5             DelayMs(25);
 271   5             if(ca2<50) ca2++;
 272   5             if(ca2>40)
 273   5             {
 274   6              st+=120;
 275   6              disp4led();     
 276   6              beep();
 277   6              DelayMs(200);
 278   6              DelayMs(100);
 279   6             }
 280   5      
 281   5            }
 282   4            cc=0;
 283   4            run=1;
 284   4          }
 285   3         }
 286   2      
 287   2      
 288   2       if(!key2)   //减1分
 289   2        {
 290   3         DelayMs(30);
 291   3         if(!key2)
 292   3          {
 293   4           if(st>59)
 294   4           {
 295   5            st-=60;
 296   5            cc=0;
 297   5            run=1;
 298   5           }
 299   4           disp4led();     
 300   4           beep();
 301   4           while(!key2) DelayMs(30);
 302   4          }
 303   3         }
C51 COMPILER V7.06   TEST                                                                  11/30/2018 13:41:24 PAGE 6   

 304   2      
 305   2       
 306   2       if(!key3)   //清零
 307   2        {
 308   3         DelayMs(30);
 309   3         if(!key3)
 310   3          {
 311   4           run=0;
 312   4           cc=0;
 313   4           st=0;
 314   4           print(1,22,0);
 315   4           print(2,22,0);
 316   4           print(3,22,0);
 317   4           print(4,15,0);
 318   4           print(5,22,0);
 319   4           print(6,22,0);
 320   4           print(7,22,0);
 321   4           print(8,22,0);
 322   4           beep();
 323   4           DelayMs(250);
 324   4           beep();     beep();
 325   4           while(!key3) DelayMs(30);
 326   4           disp4led();     
 327   4          }
 328   3         }
 329   2      
 330   2      
 331   2      
 332   2       if(run)
 333   2        if(st==0)
 334   2        {
 335   3         disp4led();
 336   3         run=0;
 337   3         for(i=0;i<20;i++)
 338   3         {
 339   4          led=~led;
 340   4          beep();
 341   4          if(!key1) i=100;  //如果有按键按下，就退出
 342   4          if(!key2) i=100;
 343   4          if(!key3) i=100;
 344   4          DelayMs(200);
 345   4          led=~led;
 346   4          beep1();
 347   4          if(!key1) i=100;
 348   4          if(!key2) i=100;
 349   4          if(!key3) i=100;
 350   4          DelayMs(200);
 351   4         }
 352   3         while(!key1);  //等等松开按键，再重新开始
 353   3         while(!key2);
 354   3         while(!key3);
 355   3         DelayMs(200);
 356   3        }
 357   2      
 358   2      
 359   2      }  //whlie结束
 360   1      
 361   1      }
 362          


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V7.06   TEST                                                                  11/30/2018 13:41:24 PAGE 7   

   CODE SIZE        =   1476    ----
   CONSTANT SIZE    =     88    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
